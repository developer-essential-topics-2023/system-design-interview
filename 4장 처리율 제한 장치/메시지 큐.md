# 메시지 큐

---

## 개념

메시지 큐는 비동기 통신을 위한 핵심 요소로, 분산 시스템에서 발생하는 데이터의 비동기적 전달을 관리하는 소프트웨어 패턴이다.

메시지를 생성하고 소비하는 컴포넌트 간에 중간에 **대기열(queue)**을 통해 메시지를 전달함으로써 통신을 이루는 방식이다. 

메시지 큐는 보통 **선입선출(FIFO)** 방식으로 메시지를 처리하며, 여러 개의 **생산자(Producer)와 소비자(Consumer) 간에 비동기적인 통신**을 지원한다.

## 특징(장점)

### 1. 비동기 통신 지원

메시지 큐는 비동기 통신을 지원하여, 메시지 발신자와 수신자 간의 결합도를 낮춘다.

메시지를 생성한 후에도 즉시 처리되지 않고 대기열에 저장되므로, 메시지 수신자는 자신의 처리 능력에 맞게 메시지를 가져와 처리할 수 있다.

이는 시스템의 유연성과 확장성을 높여준다.

### 2. 탄력적인 시스템 구성

메시지 큐를 사용하면 **각 컴포넌트가 독립적으로 작동**할 수 있으므로 시스템이 분산되고 탄력적으로 구성될 수 있다. 컴포넌트 간의 결합도가 낮아지므로 시스템 확장, 유지보수, 장애 대응 등이 용이해진다.

> 느슨한 결합도가 필요한 이유?
타 시스템에 대한 의존과 영향도를 줄이고 각 시스템의 목적에 집중함으로써 강한 응집을 갖는 시스템을 만들 수 있다.
> 

### 3. 결함 허용성과 견고성

메시지 큐는 메시지를 안전하게 보관하고 중복 메시지를 제거하여 **안정적인 데이터 처리를 보장**한다. 

메시지 큐 시스템의 일부 구성 요소가 실패하더라도 메시지는 안전하게 보존되며, 장애 복구 시에도 유실되지 않고 처리될 수 있다. 이는 시스템의 견고성과 데이터 신뢰성을 향상시킨다.

# 메시지 큐의 원리

---

## 메시지 큐의 구성 요소

### 메시지(Message)

메시지 큐를 통해 전달되는 데이터 단위

메시지는 송신자(Producer)가 생성한 **정보나 이벤트**를 나타내며, 메시지 큐를 통해 수신자(Consumer)로 전송됩니다. 일반적으로 텍스트나 직렬화된 객체 형태로 표현된다.

### 메시지 큐(Queue)

메시지를 보관하는 버퍼 또는 대기열

일반적으로 선입선출(FIFO) 방식으로 동작한다.

메시지 큐는 메모리 내에 구현될 수도 있고, 디스크나 외부 저장소에 지속적으로 저장될 수도 있다. 

메시지는 메시지 큐를 통해 보관되며, 수신자가 메시지를 가져와 처리할 때까지 대기 상태에 있다.

### 생산자(Producer)

메시지를 생성하고 메시지 큐에 전송하는 주체

일반적으로 시스템의 다른 컴포넌트나 서비스, 애플리케이션이 생산자 역할을 수행한다. 

생산자는 메시지를 생성하여 메시지 큐로 보내고, 필요한 경우 메시지의 속성이나 우선순위 등을 지정할 수 있다.

### 소비자(Consumer)

메시지 큐에서 메시지를 가져와서 처리하는 주체

소비자는 메시지 큐로부터 메시지를 받아와서 특정 작업을 수행하거나 데이터를 처리한다.

 소비자는 메시지 큐에서 메시지를 가져오는 주기나 방식을 조정할 수 있으며, 다중 소비자 구성도 가능하다.

### 브로커(Broker)

메시지 큐 시스템은 종종 중개자 역할을 하는 브로커를 포함한다. 

브로커는 생산자와 소비자 간의 통신을 중재하고, 메시지의 전달, 라우팅, 저장, 제어 등을 담당한다. 브로커는 메시지 큐 시스템의 핵심 구성 요소로, 대부분의 작업은 브로커를 통해 이루어진다.

## 메시지 생산자와 소비자의 역할

생산자는 메시지를 생성하고 메시지 큐로 전송함으로써 비동기적 통신을 이끌어내며, 소비자는 메시지 큐로부터 메시지를 가져와서 처리하여 비동기적 데이터 처리를 실현한다.

## 메시지 전달 방식

생산자가 메시지를 생성하고 메시지 큐로 전송하면, 메시지 큐는 메시지를 대기열에 저장한다. 

이후 소비자는 메시지 큐로부터 메시지를 가져와 처리한다.

⇒ 메시지는 생산자와 소비자 간에 비동기적으로 전달되고 처리된다.

# 메시지 큐를 활용하는 대표적인 사례

---

## 이벤트 기반 아키텍처 Event Driven Architecture

이벤트 기반 아키텍처에서는 메시지 큐를 활용하여 시스템 내부 및 외부에서 발생하는 이벤트를 비동기적으로 처리한다.

이벤트가 발생하면 해당 이벤트를 메시지로 변환하여 메시지 큐에 전송하고, 이벤트 핸들러가 메시지 큐로부터 이벤트를 수신하여 처리한다. 이를 통해 시스템은 실시간으로 이벤트에 대응하고 유연하게 확장될 수 있다.

## 분산 시스템 간 통신

여러 시스템이나 애플리케이션은 메시지 큐를 중간 매개체로 사용하여 데이터를 전달하고 처리한다. 이를 통해 시스템 간의 상호 운영성을 향상시키고 독립성을 유지할 수 있다.

## 대규모 데이터 처리

메시지 큐는 대규모 데이터 처리 시스템에서 데이터 스트림 처리를 위해 활용된다. 

데이터 스트림을 메시지로 변환하여 메시지 큐에 전송하고, 다양한 소비자가 메시지를 구독하여 데이터를 처리한다. 

이를 통해 실시간 데이터 처리, 스트리밍 분석, 이상 탐지 등의 작업을 효율적으로 수행할 수 있다.

> 데이터 스트림 :
실시간으로 생성되거나 전송되는 데이터의 일련의 이벤트 또는 업데이트
센서 데이터, 로그 데이터, 웹 애플리케이션의 사용자 동작 로그 등 다양한 형태의 데이터를 포함할 수 있다.
> 

# 메시지 브로커와 이벤트 브로커

---

## 메시지 브로커

대규모 메시지 기반 미들웨어 아키텍처

> 미들웨어 :
서비스하는 어플리케이션들을 보다 효율적으로 아키텍처들과 연결해주는 소프트웨어
ex ) 메시징 플랫폼, 인증 플랫폼, 데이터베이스
> 

### 특징

- 메시지 브로커에 있는 큐에 데이터를 보내고 받는 Producer와 Consumer를 통해 메시지를 통신하고, 네트워크를 맺기 위해 사용한다.
- 메시지를 받아 처리하고 난뒤, 즉시 혹은 짧은 시간 내에 삭제된다.

**⇒ 메시지 브로커는 데이터를 보내고, 처리하고, 삭제한다!**

### 예시

Redis, RabbitMQ

## 이벤트 브로커

### 특징

- 이벤트 혹은 메시지라고 불리는 이러한 레코드를 딱 1개만 보관하고, 인덱스를 통해 개별 access를 관리한다.
- 업무상 필요한 시간동안 이벤트를 보존할 수 있다.
- **이벤트를 (마치 DB에 저장하듯이) 이벤트의 브로커의 큐에 저장하고, 삭제하지 않는다.**
    - 단일 진실 공급원으로 사용할 수 있다.
    - 장애가 일어난 지점부터 재 처리할 수 있다.
    - 많은 양의 실시간 스트림 데이터를 효과적으로 처리할 수 있다.
    - 이벤트 기반 마이크로서비스 아키텍처에서 중요한 역할을 한다.

### 예시

아파치 카프카, aws 키네시스
